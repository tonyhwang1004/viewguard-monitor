# 🎯 순차 채널 전환 방식 가이드

## 📌 개요

16개 채널을 한꺼번에 보면 화질이 떨어져 정확도가 낮아집니다. 
**순차 전환 방식**은 채널을 하나씩 고화질로 전환하면서 캡처하여 **최고 정확도**를 달성합니다!

### 🎯 장점
- ✅ **고화질 분석**: 각 채널을 전체 화면으로 캡처
- ✅ **높은 정확도**: MediaPipe가 선명한 이미지로 분석
- ✅ **자동화**: 채널 버튼 자동 클릭으로 무인 운영
- ✅ **효율적**: 16개 채널을 약 60초에 한 바퀴 순회

### ⚙️ 작동 방식
```
1. CH 01 버튼 클릭 → 화면 캡처 → 졸음 분석
2. CH 02 버튼 클릭 → 화면 캡처 → 졸음 분석
3. CH 03 버튼 클릭 → 화면 캡처 → 졸음 분석
...
16. CH 16 버튼 클릭 → 화면 캡처 → 졸음 분석
17. 다시 CH 01로 (무한 반복)
```

---

## 🚀 빠른 시작

### 1단계: 채널 버튼 위치 설정

처음 한 번만 실행하면 됩니다!

```bash
python channel_setup.py
```

#### 설정 순서:

**Step 1: 캡처 영역 지정**
1. 뷰가드웹을 띄워둔 상태에서 실행
2. 마우스로 드래그하여 영상 영역 선택
3. `Enter` 키로 확정

**Step 2: 채널 버튼 클릭**
1. 화면 하단의 `CH 01` 버튼 클릭
2. `CH 02` 버튼 클릭
3. ...
4. `CH 16` 버튼까지 순서대로 클릭
5. `S` 키로 저장

> 💡 **팁**: 실수로 잘못 클릭했으면 `D` 키로 마지막 버튼 삭제

설정이 완료되면 `config/channel_positions.json` 파일이 생성됩니다.

---

### 2단계: 모니터링 시작

```bash
# 기본 모드
python src/main_sequential.py

# 디버그 모드 (화면 보면서 확인)
python src/main_sequential.py --debug
```

---

## 📊 동작 예시

### 콘솔 출력:
```
=================================================================
🔄 사이클 #1 시작
⏰ 2025-10-24 14:30:00
=================================================================

[1/16] CH01 처리 중...
✅ CH01로 전환 완료
📸 캡처 완료 (1920x1080)
💤 [CH01] 졸음 감지! (카운트: 3/5, 신뢰도: 85.3%, EAR: 0.182, Tilt: 0.612)

[2/16] CH02 처리 중...
✅ CH02로 전환 완료
📸 캡처 완료 (1920x1080)

...

[16/16] CH16 처리 중...
✅ CH16로 전환 완료
📸 캡처 완료 (1920x1080)

=================================================================
✅ 사이클 #1 완료
⏱️  소요 시간: 48.2초
📊 이번 사이클: 체크 16회, 졸음 감지 2건
=================================================================

⏸️  다음 사이클까지 대기 중...
```

---

## ⚙️ 설정

### config/settings.json

```json
{
  "detection": {
    "ear_threshold": 0.2,
    "head_tilt_threshold": 0.58,
    "confidence_threshold": 0.75,
    "drowsy_count_threshold": 5,
    "check_interval": 2,
    "alert_cooldown": 300
  }
}
```

### 순차 모드 특수 설정

**main_sequential.py 내부에서 수정:**

```python
# 전체 사이클 주기 (초)
self.FULL_CYCLE_INTERVAL = 60  # 기본 60초

# 채널 전환 후 대기 시간 (초)
self.SWITCH_DELAY = 1.2  # 화면 전환 안정화

# 캡처 전 추가 대기 (초)
self.CAPTURE_DELAY = 0.3  # 렌더링 완료 대기
```

---

## 🎮 사용 팁

### 1. 뷰가드웹 창 위치 고정
- 채널 버튼 위치가 바뀌면 재설정 필요
- 창 크기/위치를 고정하세요

### 2. 다른 창 숨기기
- 뷰가드웹이 다른 창에 가려지지 않도록
- 화면 캡처 시 최상단에 위치해야 함

### 3. 화면 보호기/절전 모드 끄기
- 자동 절전 모드 해제
- 화면 꺼짐 방지

### 4. 디버그 모드 활용
```bash
python src/main_sequential.py --debug
```
- 실시간으로 감지 결과 확인
- 정확도 체크 가능
- 문제 발생 시 원인 파악

---

## 🔧 문제 해결

### Q: 채널이 전환되지 않아요
**A**: 채널 버튼 위치를 재설정하세요
```bash
python channel_setup.py
```

### Q: 화면 캡처가 검은색이에요
**A**: 
1. 뷰가드웹이 최상단 창인지 확인
2. 관리자 권한으로 실행
3. 캡처 영역을 다시 설정

### Q: 사이클이 너무 느려요
**A**: 대기 시간 줄이기
```python
# channel_controller.py에서
self.SWITCH_DELAY = 0.8  # 1.2 → 0.8초로 줄이기
```

### Q: 너무 자주 알림이 와요
**A**: 임계값 조정
```json
{
  "detection": {
    "drowsy_count_threshold": 7,  // 5 → 7로 증가
    "confidence_threshold": 0.80  // 0.75 → 0.80으로 증가
  }
}
```

---

## 📈 성능 비교

| 방식 | 해상도 | 정확도 | 장점 | 단점 |
|------|--------|--------|------|------|
| **16분할 화면** | 낮음 | 70% | 동시 확인 | 화질 저하 |
| **순차 전환** ⭐ | 높음 | 95%+ | 고화질 분석 | 순차 처리 |

---

## 🎯 추천 워크플로우

### 초기 설정
```bash
1. pip install -r requirements.txt
2. python channel_setup.py  # 채널 버튼 설정
3. python src/main_sequential.py --debug  # 테스트
4. 문제없으면 --debug 제거하고 실행
```

### 일상 운영
```bash
# 하루 시작 시
python src/main_sequential.py

# 백그라운드 실행 (Windows)
start /min python src/main_sequential.py
```

---

## 🔄 기존 방식과 비교

### 기존 (main.py)
- 16분할 화면을 한 번에 캡처
- 각 좌석 ROI를 개별 분석
- 화질이 낮아 정확도 떨어짐

### 순차 방식 (main_sequential.py) ⭐
- 채널을 하나씩 전체 화면으로 전환
- 고화질 이미지로 분석
- 최고 정확도

---

## 📞 지원

문제가 있으면:
1. 디버그 모드로 실행해서 로그 확인
2. `config/channel_positions.json` 파일 확인
3. GitHub Issues에 질문

**Happy Monitoring! 🎓✨**
